{% extends 'finance/base.html' %}

{% block title %}Dashboard - FinSIGHT{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header Section -->
    <div class="glass-card p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    Welcome back, {{ user.username }}! ðŸ‘‹
                </h1>
                <p class="text-gray-600">Here's your financial overview</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="syncTransactions()" class="btn-primary text-white px-6 py-3 rounded-lg font-medium flex items-center space-x-2">
                    <i class="fas fa-sync-alt" id="syncIcon"></i>
                    <span>Sync Transactions</span>
                </button>
                <button onclick="generateInsights()" class="bg-green-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-600 transition flex items-center space-x-2">
                    <i class="fas fa-brain"></i>
                    <span>Generate AI Insights</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="glass-card p-6 stat-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Total Spent (30d)</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-2" id="totalSpent">$0.00</h3>
                </div>
                <div class="bg-purple-100 p-4 rounded-full">
                    <i class="fas fa-wallet text-purple-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="glass-card p-6 stat-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Transactions</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-2" id="transactionCount">{{ recent_transactions|length }}</h3>
                </div>
                <div class="bg-blue-100 p-4 rounded-full">
                    <i class="fas fa-exchange-alt text-blue-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="glass-card p-6 stat-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Anomalies Detected</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-2" id="anomalyCount">0</h3>
                </div>
                <div class="bg-red-100 p-4 rounded-full">
                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="glass-card p-6 stat-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Savings Goal</p>
                    <h3 class="text-2xl font-bold text-gray-800 mt-2" id="savingsGoal">${{ profile.monthly_savings_goal }}</h3>
                </div>
                <div class="bg-green-100 p-4 rounded-full">
                    <i class="fas fa-piggy-bank text-green-600 text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Spending Over Time -->
        <div class="glass-card p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Spending Over Time (Last 30 Days)</h3>
            <canvas id="spendingChart"></canvas>
        </div>

        <!-- Category Pie Chart -->
        <div class="glass-card p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Spending by Category</h3>
            <canvas id="categoryPieChart"></canvas>
        </div>
    </div>

    <!-- Top 4 Categories Charts -->
    <div class="glass-card p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Top 4 Categories Breakdown</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="topCategoriesCharts">
            <!-- Will be populated dynamically -->
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <button onclick="detectRecurring()" class="glass-card p-6 text-center hover:shadow-xl transition cursor-pointer">
            <div class="bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-repeat text-purple-600 text-2xl"></i>
            </div>
            <h4 class="text-lg font-bold text-gray-800 mb-2">Detect Recurring Payments</h4>
            <p class="text-gray-600 text-sm">Automatically identify recurring expenses</p>
        </button>

        <button onclick="detectAnomalies()" class="glass-card p-6 text-center hover:shadow-xl transition cursor-pointer">
            <div class="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-search text-red-600 text-2xl"></i>
            </div>
            <h4 class="text-lg font-bold text-gray-800 mb-2">Detect Anomalies</h4>
            <p class="text-gray-600 text-sm">Find unusual spending patterns</p>
        </button>

        <button onclick="viewForecast()" class="glass-card p-6 text-center hover:shadow-xl transition cursor-pointer">
            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-crystal-ball text-blue-600 text-2xl"></i>
            </div>
            <h4 class="text-lg font-bold text-gray-800 mb-2">View Forecast</h4>
            <p class="text-gray-600 text-sm">See next month's predictions</p>
        </button>
    </div>

    <!-- Recent Transactions & Insights -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Transactions -->
        <div class="glass-card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">Recent Transactions</h3>
                <a href="{% url 'transactions' %}" class="text-purple-600 hover:text-purple-700 text-sm font-medium">
                    View All <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div class="space-y-3" id="recentTransactions">
                {% if recent_transactions %}
                    {% for t in recent_transactions %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                                <i class="fas fa-shopping-bag text-purple-600"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">{{ t.description }}</p>
                                <p class="text-sm text-gray-500">{{ t.date|date:"M d, Y" }} â€¢ {{ t.category.name|default:"Uncategorized" }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-800">${{ t.amount }}</p>
                            {% if t.is_anomaly %}
                            <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">Anomaly</span>
                            {% endif %}
                            {% if t.is_recurring %}
                            <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">Recurring</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-500 text-center py-8">No transactions yet. Sync with your bank or add manually!</p>
                {% endif %}
            </div>
        </div>

        <!-- Latest Insights -->
        <div class="glass-card p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">Latest Insights</h3>
                <a href="{% url 'insights' %}" class="text-purple-600 hover:text-purple-700 text-sm font-medium">
                    View All <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            <div id="latestInsights">
                {% if latest_insight %}
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-lightbulb text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 mb-2">{{ latest_insight.get_insight_type_display }}</h4>
                            <p class="text-gray-700 text-sm">{{ latest_insight.insight_text }}</p>
                            <p class="text-xs text-gray-500 mt-2">{{ latest_insight.created_at|date:"F d, Y" }}</p>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-gray-500 text-center py-8">No insights yet. Generate one!</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Pending Confirmations -->
    {% if pending_confirmations %}
    <div class="glass-card p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-bell text-yellow-500 mr-2"></i>
            Pending Recurring Payment Confirmations
        </h3>
        <div class="space-y-4">
            {% for confirmation in pending_confirmations %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex items-center justify-between">
                <div>
                    <h4 class="font-semibold text-gray-800">{{ confirmation.description }}</h4>
                    <p class="text-sm text-gray-600">
                        Amount: ${{ confirmation.amount }} â€¢ Frequency: {{ confirmation.frequency }} â€¢ 
                        Confidence: {{ confirmation.confidence_score|floatformat:0 }}%
                    </p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="confirmRecurring({{ confirmation.id }}, 'confirm')" 
                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                        <i class="fas fa-check mr-1"></i>Confirm
                    </button>
                    <button onclick="confirmRecurring({{ confirmation.id }}, 'reject')" 
                            class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                        <i class="fas fa-times mr-1"></i>Reject
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Forecast Modal -->
<div id="forecastModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="glass-card p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Next Month Forecast</h2>
            <button onclick="closeForecast()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="forecastContent"></div>
    </div>
</div>

<script>
let spendingChart, categoryPieChart;

// Load dashboard data on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded, initializing charts...');
    loadDashboardData();
});

function loadDashboardData() {
    console.log('Loading dashboard data...');
    showLoading();
    
    fetch('/api/dashboard/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('Dashboard API response:', response.status);
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log('Dashboard data received:', data);
        hideLoading();
        updateStats(data);
        createCharts(data);
    })
    .catch(error => {
        console.error('Error loading dashboard:', error);
        hideLoading();
        showNotification('Error loading dashboard data. Using template data.', 'warning');
        // Use template data as fallback
        createBasicCharts();
    });
}

function updateStats(data) {
    if (data.spending) {
        document.getElementById('totalSpent').textContent = formatCurrency(data.spending.total_last_30_days || 0);
    }
    if (data.anomalies) {
        document.getElementById('anomalyCount').textContent = data.anomalies.count || 0;
    }
}

function createCharts(data) {
    if (!data.recent_transactions || data.recent_transactions.length === 0) {
        console.log('No transaction data, creating empty charts');
        createBasicCharts();
        return;
    }
    
    // Spending Over Time Chart
    const ctx1 = document.getElementById('spendingChart').getContext('2d');
    if (spendingChart) spendingChart.destroy();
    
    const dates = data.recent_transactions.map(t => formatDate(t.date));
    const amounts = data.recent_transactions.map(t => t.amount);
    
    spendingChart = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Daily Spending',
                data: amounts,
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Spent: ' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });

    // Category Pie Chart
    const ctx2 = document.getElementById('categoryPieChart').getContext('2d');
    if (categoryPieChart) categoryPieChart.destroy();
    
    const categoryData = data.spending?.by_category || {};
    const categories = Object.keys(categoryData);
    const categoryAmounts = Object.values(categoryData);
    
    if (categories.length > 0) {
        categoryPieChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: categories,
                datasets: [{
                    data: categoryAmounts,
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#4facfe',
                        '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Top 4 Categories
        createTop4CategoryCharts(categoryData);
    }
}

function createBasicCharts() {
    // Create empty placeholder charts
    const ctx1 = document.getElementById('spendingChart').getContext('2d');
    if (spendingChart) spendingChart.destroy();
    
    spendingChart = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: ['No Data'],
            datasets: [{
                label: 'Daily Spending',
                data: [0],
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } }
        }
    });

    const ctx2 = document.getElementById('categoryPieChart').getContext('2d');
    if (categoryPieChart) categoryPieChart.destroy();
    
    categoryPieChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['No Data'],
            datasets: [{
                data: [1],
                backgroundColor: ['#e5e7eb']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

function createTop4CategoryCharts(categoryData) {
    const sorted = Object.entries(categoryData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 4);
    
    const container = document.getElementById('topCategoriesCharts');
    container.innerHTML = '';
    
    if (sorted.length === 0) {
        container.innerHTML = '<p class="text-gray-500 col-span-4 text-center py-8">No category data available</p>';
        return;
    }
    
    sorted.forEach(([category, amount], index) => {
        const chartDiv = document.createElement('div');
        chartDiv.className = 'glass-card p-4';
        chartDiv.innerHTML = `
            <h4 class="font-semibold text-gray-700 mb-2 text-center">${category}</h4>
            <canvas id="topChart${index}"></canvas>
            <p class="text-center text-2xl font-bold text-purple-600 mt-2">${formatCurrency(amount)}</p>
        `;
        container.appendChild(chartDiv);
        
        const ctx = document.getElementById(`topChart${index}`).getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Spending'],
                datasets: [{
                    data: [amount],
                    backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe'][index]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: { callback: value => '$' + value }
                    }
                }
            }
        });
    });
}

function syncTransactions() {
    console.log('Sync button clicked');
    showLoading();
    const syncIcon = document.getElementById('syncIcon');
    syncIcon.classList.add('fa-spin');
    
    fetch('/api/plaid/sync/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        credentials: 'same-origin',
        body: JSON.stringify({ force_sync: false })
    })
    .then(response => {
        console.log('Sync response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Sync data:', data);
        hideLoading();
        syncIcon.classList.remove('fa-spin');
        if (data.success) {
            showNotification(`Synced ${data.added || 0} new transactions!`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.error || 'Sync failed. Please connect your bank account first.', 'error');
        }
    })
    .catch(error => {
        console.error('Sync error:', error);
        hideLoading();
        syncIcon.classList.remove('fa-spin');
        showNotification('Sync not available. Please connect your bank account in Profile settings.', 'warning');
    });
}

function detectRecurring() {
    console.log('Detect recurring button clicked');
    showLoading();
    
    fetch('/api/recurring/detect/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('Detect recurring response:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Recurring data:', data);
        hideLoading();
        if (data.success) {
            showNotification(`Found ${data.patterns_found || 0} recurring patterns!`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('No recurring patterns found', 'info');
        }
    })
    .catch(error => {
        console.error('Recurring error:', error);
        hideLoading();
        showNotification('Error detecting recurring payments. Make sure you have transactions first.', 'error');
    });
}

function confirmRecurring(id, action) {
    console.log('Confirm recurring:', id, action);
    showLoading();
    
    fetch(`/api/recurring/${id}/confirm/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        credentials: 'same-origin',
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Confirm response:', data);
        hideLoading();
        showNotification(data.message || 'Action completed', 'success');
        setTimeout(() => location.reload(), 1000);
    })
    .catch(error => {
        console.error('Confirm error:', error);
        hideLoading();
        showNotification('Error processing confirmation', 'error');
    });
}

function detectAnomalies() {
    console.log('Detect anomalies button clicked');
    showLoading();
    
    fetch('/api/analytics/anomalies/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('Anomalies response:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Anomalies data:', data);
        hideLoading();
        if (data.success) {
            showNotification(`Found ${data.anomaly_count || 0} anomalies!`, 'success');
            document.getElementById('anomalyCount').textContent = data.anomaly_count || 0;
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification('No anomalies detected', 'info');
        }
    })
    .catch(error => {
        console.error('Anomalies error:', error);
        hideLoading();
        showNotification('Error detecting anomalies. Make sure you have enough transaction data.', 'error');
    });
}

function generateInsights() {
    console.log('Generate insights button clicked');
    showLoading();
    
    fetch('/api/insights/generate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('Insights response:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Insights data:', data);
        hideLoading();
        if (data.success) {
            showNotification('AI insights generated successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.error || 'Error generating insights', 'error');
        }
    })
    .catch(error => {
        console.error('Insights error:', error);
        hideLoading();
        showNotification('Error generating insights. This feature requires transaction data and AI service.', 'error');
    });
}

function viewForecast() {
    console.log('View forecast button clicked');
    showLoading();
    
    fetch('/api/analytics/forecast/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('Forecast response:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Forecast data:', data);
        hideLoading();
        if (data.success) {
            displayForecast(data.forecast);
        } else {
            showNotification('Error loading forecast', 'error');
        }
    })
    .catch(error => {
        console.error('Forecast error:', error);
        hideLoading();
        showNotification('Error loading forecast. Make sure you have transaction data.', 'error');
    });
}

function displayForecast(forecast) {
    const modal = document.getElementById('forecastModal');
    const content = document.getElementById('forecastContent');
    
    content.innerHTML = `
        <div class="space-y-6">
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg p-6">
                <h3 class="text-2xl font-bold mb-2">Predicted Spending</h3>
                <p class="text-4xl font-bold">${formatCurrency(forecast.predicted_spending || 0)}</p>
                <p class="text-sm opacity-90 mt-2">
                    Period: ${formatDate(forecast.forecast_period.start)} - ${formatDate(forecast.forecast_period.end)}
                </p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-1">Fixed Payments</p>
                    <p class="text-2xl font-bold text-blue-600">${formatCurrency(forecast.breakdown?.fixed_payments || 0)}</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-1">Variable Spending</p>
                    <p class="text-2xl font-bold text-green-600">${formatCurrency(forecast.breakdown?.variable_spending || 0)}</p>
                </div>
            </div>
            
            <div>
                <h4 class="font-bold text-gray-800 mb-3">Upcoming Payment Schedule</h4>
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    ${(forecast.payment_schedule || []).map(payment => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <p class="font-semibold text-gray-800">${payment.name}</p>
                                <p class="text-sm text-gray-500">${formatDate(payment.date)}</p>
                            </div>
                            <p class="font-bold text-gray-800">${formatCurrency(payment.amount)}</p>
                        </div>
                    `).join('') || '<p class="text-gray-500 text-center py-4">No upcoming payments scheduled</p>'}
                </div>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

function closeForecast() {
    document.getElementById('forecastModal').classList.add('hidden');
}
</script>
{% endblock %}